stages:
  - cyw20829_build
  - build_blinky
  - build_mcuboot_smif
  - build_mcuboot
  - cyw20829_test
  - 512k_swap_tests
  - 1m_swap_tests
  - 2m_swap_tests
  - 512k_overwrite_tests
  - 1m_overwrite_tests
  - 2m_overwrite_tests
  - mcuboot_simulator
  - code_quality_check

variables:
  #  Uncommnet `COV` variable to run coverity tests only
  # COV: #Any_value

  # MCUBoot/Bootloader test selectors. Can be overwriten by CI variables.
  # TWO_TESTS - minimal boot/upgrade positive tests
  # THREE_TESTS - two positive and one negative test
  # SMOKE - short basic tests with swap (optional)
  # OVERNIGHT - extended tests for overnight pipeline
  # ALL - complete set of all suite tests
  # CUSTOM - manualy selected tests in MCUBoot suite repository

    TEST_SWAP: SMOKE
    TEST_SWAP_RELEASE: TWO_TESTS

    TEST_OVERWRITE: SMOKE
    TEST_OVERWRITE_RELEASE: TWO_TESTS

    TEST_RBC: RBC_ALL
    TEST_RBC_RELEASE: RBC_OVERNIGHT

  # Skip all following tests when fail (062 only)
    ERREXIT: 'True'

  # Branch or tag seletct for test suite
    TEST_BRANCH_062: test/boot_timeout
    TEST_BRANCH_20829: mcuboot_ci_tag

  # Branch or tag with cysecuretools for 20829
    CY_SECURETOOLS_BRANCH: CYW20829_ES100_TC2
    TESTAPPS_CYW20829_BRANCH: testapps_cyw20829

  # Branch with CppCheck scripts and config
    CPPCHECK_BRANCH: pr/cypress-mcuboot-cppcheck

  # Brach with Coverity scripts and confings
    COVERITY_BRANCH: feature/mcuboot_config

  # DO NOT EDIT. Internal CI runner tools path
    OBJCOPY_PATH: C:/Users/fw_security/ModusToolbox/tools_2.3/gcc/bin/arm-none-eabi-objcopy
# OPENOCD 1430 (from MTB 2.3) doesn`t work correctly with mcuboot test suite
#    OPENOCD_PATH: C:/Users/fw_security/ModusToolbox/tools_2.0/openocd
#    TOOLCHAIN_PATH: C:/Users/cydesigner/ModusToolbox/tools_2.3/gcc
#    TOOLCHAIN_PATH: /Applications/ModusToolbox/tools_2.0/gcc-7.2.1
#    TOOLCHAIN_PATH: /home/fw-security/ModusToolbox/tools_2.3/gcc

######################################################################################################################################
######################################################  2 0 8 2 9   B U I L D  #######################################################
######################################################################################################################################

.cyw20829_build_mcuboot:
  stage: cyw20829_build
  tags:
#    - FWS_LIN_BUILD
    - FWS_MAC_BUILD
#    - PCVP30_WIN_BUILD
  variables:
    GIT_STRATEGY: fetch
#    TOOLCHAIN_PATH: /home/fw-security/ModusToolbox/tools_2.3/gcc
    TOOLCHAIN_PATH: /Applications/ModusToolbox/tools_2.3/gcc
#    TOOLCHAIN_PATH: C:/Users/PCVP30User/ModusToolbox/tools_2.4/gcc
  needs: []
  artifacts:
    expire_in: 4 weeks
    paths:
      - boot/cypress/MCUBootApp/out/CYW20829/Debug/MCUBootApp.elf
      - boot/cypress/MCUBootApp/out/CYW20829/Debug/*.hex
      - boot/cypress/MCUBootApp/out/CYW20829/Debug/*.bin

      - boot/cypress/MCUBootApp/out/CYW20829/Release/MCUBootApp.elf
      - boot/cypress/MCUBootApp/out/CYW20829/Release/*.hex
      - boot/cypress/MCUBootApp/out/CYW20829/Release/*.bin

      - boot/cypress/BlinkyApp/out/CYW20829/Debug/boot/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/CYW20829/Debug/boot/*.hex
      - boot/cypress/BlinkyApp/out/CYW20829/Debug/boot/*.bin
      - boot/cypress/BlinkyApp/out/CYW20829/Debug/upgrade/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/CYW20829/Debug/upgrade/*.hex
      - boot/cypress/BlinkyApp/out/CYW20829/Debug/upgrade/*.bin

      - boot/cypress/BlinkyApp/out/CYW20829/Release/boot/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/CYW20829/Release/boot/*.hex
      - boot/cypress/BlinkyApp/out/CYW20829/Release/boot/*.bin
      - boot/cypress/BlinkyApp/out/CYW20829/Release/upgrade/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/CYW20829/Release/upgrade/*.hex
      - boot/cypress/BlinkyApp/out/CYW20829/Release/upgrade/*.bin

      - boot/cypress/keys/encrypt_key.bin
      - boot/cypress/keys/priv_oem_0.pem
      - boot/cypress/keys/pub_oem_0.pem
      - boot/cypress/packets/debug_cert.bin

  script:
    - git submodule sync --recursive
    - git submodule update --init --recursive

    - python -V
    - virtualenv venv
    - source venv/bin/activate
#    - ./venv/scripts/activate.ps1
    - python -V

    - pip install git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${CY_SECURETOOLS_BRANCH}
    - pip install git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${TESTAPPS_CYW20829_BRANCH}
    - cysecuretools -v version

    - cd boot/cypress
    - cysecuretools -t cyw20829 init --testapps
    - python ./scripts/rbc_policy_and_cert_revision_modify.py
    - cysecuretools -t cyw20829 -p policy/policy_secure.json create-key --aes
    - cysecuretools -t cyw20829 -p policy/policy_secure.json create-key -k 0
    - cysecuretools -t cyw20829 -p policy/policy_secure.json debug-certificate -t packets/debug_cert.json -o packets/debug_cert.bin -k 0

    - echo make app BUILDCFG=Debug   ENC_IMG=${CIVAR_ENCRYPT} LCS=${CIVAR_LCS} APP_NAME=MCUBootApp PLATFORM=CYW20829 CYW20829_PSVP=1 FLASH_MAP=${CIVAR_FLASH_MAP}
    -      make app BUILDCFG=Debug   ENC_IMG=${CIVAR_ENCRYPT} LCS=${CIVAR_LCS} APP_NAME=MCUBootApp PLATFORM=CYW20829 CYW20829_PSVP=1 FLASH_MAP=${CIVAR_FLASH_MAP}
    -      make app BUILDCFG=Release ENC_IMG=${CIVAR_ENCRYPT} LCS=${CIVAR_LCS} APP_NAME=MCUBootApp PLATFORM=CYW20829 CYW20829_PSVP=1 FLASH_MAP=${CIVAR_FLASH_MAP}

    - echo make app BUILDCFG=Debug IMG_TYPE=BOOT ENC_IMG=${CIVAR_ENCRYPT} APP_DEFAULT_POLICY=${CIVAR_POLICY} APP_NAME=BlinkyApp PLATFORM=CYW20829 FLASH_MAP=${CIVAR_FLASH_MAP} IMG_ID=1
    - make app BUILDCFG=Debug   IMG_TYPE=BOOT    ENC_IMG=${CIVAR_ENCRYPT} APP_DEFAULT_POLICY=${CIVAR_POLICY} APP_NAME=BlinkyApp PLATFORM=CYW20829 FLASH_MAP=${CIVAR_FLASH_MAP} IMG_ID=1
    - make app BUILDCFG=Debug   IMG_TYPE=UPGRADE ENC_IMG=${CIVAR_ENCRYPT} APP_DEFAULT_POLICY=${CIVAR_POLICY} APP_NAME=BlinkyApp PLATFORM=CYW20829 FLASH_MAP=${CIVAR_FLASH_MAP} IMG_ID=1
    - make app BUILDCFG=Release IMG_TYPE=BOOT    ENC_IMG=${CIVAR_ENCRYPT} APP_DEFAULT_POLICY=${CIVAR_POLICY} APP_NAME=BlinkyApp PLATFORM=CYW20829 FLASH_MAP=${CIVAR_FLASH_MAP} IMG_ID=1
    - make app BUILDCFG=Release IMG_TYPE=UPGRADE ENC_IMG=${CIVAR_ENCRYPT} APP_DEFAULT_POLICY=${CIVAR_POLICY} APP_NAME=BlinkyApp PLATFORM=CYW20829 FLASH_MAP=${CIVAR_FLASH_MAP} IMG_ID=1

  after_script:
    - deactivate
    - rm -rf ./venv


mac_20829_mcuboot_normal_swap:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_ENCRYPT: 0
    CIVAR_LCS: NORMAL_NO_SECURE
    CIVAR_POLICY:  ./policy/policy_no_secure.json
    CIVAR_FLASH_MAP: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single_psvp.json
  extends: .cyw20829_build_mcuboot


mac_20829_mcuboot_secure_swap:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_ENCRYPT: 0
    CIVAR_LCS: SECURE
    CIVAR_POLICY:  ./policy/policy_secure.json
    CIVAR_FLASH_MAP: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single_psvp.json
  extends: .cyw20829_build_mcuboot


mac_20829_mcuboot_secure_rollback_swap:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_ENCRYPT: 0
    CIVAR_LCS: SECURE
    CIVAR_POLICY:  ./policy/policy_reprovisioning_secure.json
    CIVAR_FLASH_MAP: ./cy_flash_pal/flash_cyw208xx/flashmap/hw_rollback_prot/cyw20829_xip_swap_single_psvp.json
  extends: .cyw20829_build_mcuboot


mac_20829_mcuboot_secure_encrypt_swap:
  except:
    variables:
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_ENCRYPT: 1
    CIVAR_LCS: SECURE
    CIVAR_POLICY:  ./policy/policy_secure.json
    CIVAR_FLASH_MAP: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single_psvp.json
  extends: .cyw20829_build_mcuboot


mac_20829_mcuboot_secure_encrypt_rollback_swap:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_ENCRYPT: 1
    CIVAR_LCS: SECURE
    CIVAR_POLICY:  ./policy/policy_reprovisioning_secure.json
    CIVAR_FLASH_MAP: ./cy_flash_pal/flash_cyw208xx/flashmap/hw_rollback_prot/cyw20829_xip_swap_single_psvp.json
  extends: .cyw20829_build_mcuboot


mac_20829_mcuboot_normal_overwrite:
  except:
    variables:
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_ENCRYPT: 0
    CIVAR_LCS: NORMAL_NO_SECURE
    CIVAR_POLICY:  ./policy/policy_no_secure.json
    CIVAR_FLASH_MAP: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_overwrite_single_psvp.json
  extends: .cyw20829_build_mcuboot


mac_20829_mcuboot_secure_overwrite:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_ENCRYPT: 0
    CIVAR_LCS: SECURE
    CIVAR_POLICY:  ./policy/policy_secure.json
    CIVAR_FLASH_MAP: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_overwrite_single_psvp.json
  extends: .cyw20829_build_mcuboot


mac_20829_mcuboot_secure_rollback_overwrite:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_ENCRYPT: 0
    CIVAR_LCS: SECURE
    CIVAR_POLICY:  ./policy/policy_reprovisioning_secure.json
    CIVAR_FLASH_MAP: ./cy_flash_pal/flash_cyw208xx/flashmap/hw_rollback_prot/cyw20829_xip_overwrite_single_psvp.json
  extends: .cyw20829_build_mcuboot


mac_20829_mcuboot_secure_encrypt_overwrite:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_ENCRYPT: 1
    CIVAR_LCS: SECURE
    CIVAR_POLICY:  ./policy/policy_secure.json
    CIVAR_FLASH_MAP: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_overwrite_single_psvp.json
  extends: .cyw20829_build_mcuboot


mac_20829_mcuboot_secure_encrypt_rollback_overwrite:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_ENCRYPT: 1
    CIVAR_LCS: SECURE
    CIVAR_POLICY:  ./policy/policy_reprovisioning_secure.json
    CIVAR_FLASH_MAP: ./cy_flash_pal/flash_cyw208xx/flashmap/hw_rollback_prot/cyw20829_xip_overwrite_single_psvp.json
  extends: .cyw20829_build_mcuboot


######################################################################################################################################
#################################################### C O M M O N   E X T E N D S #####################################################
######################################################################################################################################

.build_blinky:
  tags:
    - FWS_LIN_BUILD
  needs: []
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  variables:
    GIT_STRATEGY: clone
    TOOLCHAIN_PATH: /home/fw-security/ModusToolbox/tools_2.3/gcc
  artifacts:
    expire_in: 4 weeks
    paths:
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Debug/${TYPE,,}/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Release/${TYPE,,}/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Debug/${TYPE,,}/BlinkyApp.hex
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Release/${TYPE,,}/BlinkyApp.hex
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Debug/${TYPE,,}/BlinkyApp_upgrade.hex
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Release/${TYPE,,}/BlinkyApp_upgrade.hex
  script:
    - env
    - '[ ! -z $REPO ] && git remote add remote_repo $REPO'
    - '[ ! -z $REPO ] && git fetch remote_repo'
    - '[ ! -z $REPO ] && git checkout -b remote_branch remote_repo/$BRANCH'
    - '[ ! -z $REPO ] && echo "Using remote branch commit:"'
    - '[   -z $REPO ] && echo "Using current branch commit:"'
    - git rev-parse HEAD
    - git submodule deinit --all -f
    - git submodule update --init --recursive
    - cd boot/cypress
    - echo make app APP_NAME=BlinkyApp BUILDCFG=Debug   PLATFORM=PSOC_062_${PSOC^^} IMG_TYPE=${TYPE^^} FLASH_MAP=${JSON} IMG_ID=${IMG_ID^^}
    -      make app APP_NAME=BlinkyApp BUILDCFG=Debug   PLATFORM=PSOC_062_${PSOC^^} IMG_TYPE=${TYPE^^} FLASH_MAP=${JSON} IMG_ID=${IMG_ID^^}
    -      make app APP_NAME=BlinkyApp BUILDCFG=Release PLATFORM=PSOC_062_${PSOC^^} IMG_TYPE=${TYPE^^} FLASH_MAP=${JSON} IMG_ID=${IMG_ID^^}

.build_mcuboot:
  tags:
    - FWS_LIN_BUILD
  needs: []
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  variables:
    GIT_STRATEGY: clone
    TOOLCHAIN_PATH: /home/fw-security/ModusToolbox/tools_2.3/gcc
  artifacts:
    expire_in: 4 weeks
    paths:
      - boot/cypress/MCUBootApp/out/PSOC_062_${PSOC^^}/Debug/MCUBootApp.hex
      - boot/cypress/MCUBootApp/out/PSOC_062_${PSOC^^}/Release/MCUBootApp.hex
  script:
    - env
    - '[ ! -z $REPO ] && git remote add remote_repo $REPO'
    - '[ ! -z $REPO ] && git fetch remote_repo'
    - '[ ! -z $REPO ] && git checkout -b remote_branch remote_repo/$BRANCH'
    - '[ ! -z $REPO ] && echo "Using remote branch commit:"'
    - '[   -z $REPO ] && echo "Using current branch commit:"'
    - git rev-parse HEAD
    - git submodule deinit --all -f
    - git submodule update --init --recursive
    - cd boot/cypress
    - echo make app APP_NAME=MCUBootApp PLATFORM=PSOC_062_${PSOC^^} BUILDCFG=Debug   ENC_IMG=${ENCRYPT} FLASH_MAP=${JSON}
    -      make app APP_NAME=MCUBootApp PLATFORM=PSOC_062_${PSOC^^} BUILDCFG=Debug   ENC_IMG=${ENCRYPT} FLASH_MAP=${JSON}
    -      make app APP_NAME=MCUBootApp PLATFORM=PSOC_062_${PSOC^^} BUILDCFG=Release ENC_IMG=${ENCRYPT} FLASH_MAP=${JSON}

.tests_common:
  retry:
    max: 1
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  artifacts:
    when: always
    expire_in: 12 weeks
    paths:
      - cy_boot_test_suite/test_tools/authomated_run/*.txt
  script:
    - git clone http://git-ore.aus.cypress.com/YNCI/cy_boot_test_suite.git -b $TEST_BRANCH_062
    - cd cy_boot_test_suite/test_tools
    - C:/Windows/System32/cmd.exe /c create_binaries.bat
    - C:/Windows/System32/cmd.exe /c ci\mcuboot\program.bat
    - C:/Windows/System32/cmd.exe /c ci\multi_062\program.bat
    - C:/Windows/System32/cmd.exe /c execute_tests.bat

.512k_swap:
  stage: 512k_swap_tests
  tags:
    - MCUBOOT_TEST_512K_SWAP
  variables:
    OPENOCD_PATH: C:/Users/fw_security/ModusToolbox/tools_2.0/openocd
    CI_SERIAL_PORT: COM51
    TARGET_ID: 1D1E1523012A8400
    TEST_ENCRYPT: 0
  extends: .tests_common

.1m_swap:
  stage: 1m_swap_tests
  tags:
    - MCUBOOT_TEST_1M_SWAP
  variables:
    OPENOCD_PATH: C:/Users/fw_security/ModusToolbox/tools_2.0/openocd
    CI_SERIAL_PORT: COM41
    TARGET_ID: 0C25186C03227400
    TEST_ENCRYPT: 0
  extends: .tests_common

.2m_swap:
  stage: 2m_swap_tests
  tags:
    - MCUBOOT_TEST_2M_SWAP
  variables:
    OPENOCD_PATH: C:/Users/fw_security/ModusToolbox/tools_2.0/openocd
    CI_SERIAL_PORT: COM61
    TARGET_ID: 1D18021003077400
    TEST_ENCRYPT: 0
  extends: .tests_common

.2m_eval_swap:
  stage: 2m_swap_tests
  tags:
    - MCUBOOT_TEST_2M_EVAL
  variables:
    OPENOCD_PATH: C:/Users/fw_security/ModusToolbox/tools_2.0/openocd
    CI_SERIAL_PORT: COM67
    TARGET_ID: 0D0505CD00020400
    TEST_ENCRYPT: 0
  extends: .tests_common

.512k_overwrite:
  stage: 512k_overwrite_tests
  tags:
    - MCUBOOT_TEST_512K_OVERWRITE
  variables:
    OPENOCD_PATH: C:/Users/fw_security/ModusToolbox/tools_2.0/openocd
    CI_SERIAL_PORT: COM54
    TARGET_ID: 0E12080002069400
    TEST_ENCRYPT: 0
  extends: .tests_common

.1m_overwrite:
  stage: 1m_overwrite_tests
  tags:
    - MCUBOOT_TEST_1M_OVERWRITE
  variables:
    OPENOCD_PATH: C:/Users/fw_security/ModusToolbox/tools_2.0/openocd
    CI_SERIAL_PORT: COM44
    TARGET_ID: 031802F301237400
    TEST_ENCRYPT: 0
  extends: .tests_common

.2m_overwrite:
  stage: 2m_overwrite_tests
  tags:
    - MCUBOOT_TEST_2M_OVERWRITE
  variables:
    OPENOCD_PATH: C:/Users/fw_security/ModusToolbox/tools_2.0/openocd
    CI_SERIAL_PORT: COM64
    TARGET_ID: 170C0C1C02179400
    TEST_ENCRYPT: 0
  extends: .tests_common

.512k_encrypt_overwrite:
  stage: 512k_overwrite_tests
  tags:
    - MCUBOOT_TEST_512K_ENCRYPT_OVERWRITE
  variables:
    OPENOCD_PATH: C:/Users/fw_security/ModusToolbox/tools_2.0/openocd
    CI_SERIAL_PORT: COM184
    TARGET_ID: 101B0C1C02179400
    TEST_ENCRYPT: 1
  extends: .tests_common

.1m_encrypt_overwrite:
  stage: 1m_overwrite_tests
  tags:
    - MCUBOOT_TEST_1M_ENCRYPT_OVERWRITE
  variables:
    OPENOCD_PATH: C:/Users/fw_security/ModusToolbox/tools_2.0/openocd
    CI_SERIAL_PORT: COM164
    TARGET_ID: 0E240FF301237400
    TEST_ENCRYPT: 1
  extends: .tests_common

.2m_encrypt_overwrite:
  stage: 2m_overwrite_tests
  tags:
    - MCUBOOT_TEST_2M_ENCRYPT_OVERWRITE
  variables:
    OPENOCD_PATH: C:/Users/fw_security/ModusToolbox/tools_2.0/openocd
    CI_SERIAL_PORT: COM144
    TARGET_ID: 170511C900020400
    TEST_ENCRYPT: 1
  extends: .tests_common

######################################################################################################################################
#######################################################  2 0 8 2 9   A P P S  ########################################################
######################################################################################################################################

.20829_build_blinky:
  stage: cyw20829_build
  variables:
    GIT_STRATEGY: clone
  needs: []
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  artifacts:
    expire_in: 4 weeks
    paths:
      - boot/cypress/BlinkyApp/out/CYW20829/Debug/boot/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/CYW20829/Debug/boot/*.hex
      - boot/cypress/BlinkyApp/out/CYW20829/Debug/boot/*.bin
      - boot/cypress/BlinkyApp/out/CYW20829/Debug/upgrade/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/CYW20829/Debug/upgrade/*.hex
      - boot/cypress/BlinkyApp/out/CYW20829/Debug/upgrade/*.bin
      - boot/cypress/BlinkyApp/out/CYW20829/Release/boot/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/CYW20829/Release/boot/*.hex
      - boot/cypress/BlinkyApp/out/CYW20829/Release/boot/*.bin
      - boot/cypress/BlinkyApp/out/CYW20829/Release/upgrade/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/CYW20829/Release/upgrade/*.hex
      - boot/cypress/BlinkyApp/out/CYW20829/Release/upgrade/*.bin
  script:
    - git submodule deinit --all -f
    - git submodule update --init --recursive --force

    - python -V
    - pip install git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${CY_SECURETOOLS_BRANCH}
    - pip install git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${TESTAPPS_CYW20829_BRANCH}
    - cysecuretools -v version
    - cd boot/cypress
    - cysecuretools -t cyw20829 init --testapps

    - make app APP_NAME=BlinkyApp BUILDCFG=Debug   PLATFORM=CYW20829 IMG_TYPE=BOOT    FLASH_MAP=./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single.json IMG_ID=1
    - make app APP_NAME=BlinkyApp BUILDCFG=Debug   PLATFORM=CYW20829 IMG_TYPE=UPGRADE FLASH_MAP=./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single.json IMG_ID=1
    - make app APP_NAME=BlinkyApp BUILDCFG=Release PLATFORM=CYW20829 IMG_TYPE=BOOT    FLASH_MAP=./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single.json IMG_ID=1
    - make app APP_NAME=BlinkyApp BUILDCFG=Release PLATFORM=CYW20829 IMG_TYPE=UPGRADE FLASH_MAP=./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single.json IMG_ID=1

.win_20829_build_blinky:
  when: manual
  tags:
    - FWS_WIN_BUILD
  variables:
    TOOLCHAIN_PATH: C:/Users/cydesigner/ModusToolbox/tools_2.3/gcc
  before_script:
    - virtualenv venv
    - ./venv/scripts/activate.ps1
  extends: .20829_build_blinky

.mac_20829_build_blinky:
  when: manual
  tags:
    - FWS_MAC_BUILD
  variables:
    TOOLCHAIN_PATH: /Applications/ModusToolbox/tools_2.3/gcc
  before_script:
    - virtualenv venv
    - source venv/bin/activate
  extends: .20829_build_blinky

.lin_20829_build_blinky:
  when: manual
  tags:
    - FWS_LIN_BUILD
  variables:
    TOOLCHAIN_PATH: /home/fw-security/ModusToolbox/tools_2.3/gcc
  before_script:
    - virtualenv venv
    - source venv/bin/activate
  extends: .20829_build_blinky



.20829_build_mcuboot:
  stage: cyw20829_build
  variables:
    GIT_STRATEGY: clone
  needs: []
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  artifacts:
    expire_in: 4 weeks
    paths:
      - boot/cypress/MCUBootApp/out/CYW20829/Debug/MCUBootApp.elf
      - boot/cypress/MCUBootApp/out/CYW20829/Debug/*.hex
      - boot/cypress/MCUBootApp/out/CYW20829/Debug/*.bin
      - boot/cypress/MCUBootApp/out/CYW20829/Release/MCUBootApp.elf
      - boot/cypress/MCUBootApp/out/CYW20829/Release/*.hex
      - boot/cypress/MCUBootApp/out/CYW20829/Release/*.bin
  script:
    - git submodule deinit --all -f
    - git submodule update --init --recursive --force

    - python -V
    - pip install git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${CY_SECURETOOLS_BRANCH}
    - pip install git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${TESTAPPS_CYW20829_BRANCH}
    - cysecuretools -v version
    - cd boot/cypress
    - cysecuretools -t cyw20829 init --testapps

    - echo make app APP_NAME=MCUBootApp PLATFORM=${BOARD} BUILDCFG=Debug FLASH_MAP=${JSON}
    - make app APP_NAME=MCUBootApp PLATFORM=${BOARD} BUILDCFG=Debug      FLASH_MAP=${JSON}
    - make app APP_NAME=MCUBootApp PLATFORM=${BOARD} BUILDCFG=Release    FLASH_MAP=${JSON}

.win_20829_build_mcuboot_single:
  when: manual
  tags:
    - FWS_WIN_BUILD
  variables:
    TOOLCHAIN_PATH: C:/Users/cydesigner/ModusToolbox/tools_2.3/gcc
    BOARD: CYW20829
    JSON: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single.json
  before_script:
    - virtualenv venv
    - ./venv/scripts/activate.ps1
  extends: .20829_build_mcuboot

.win_20829_build_mcuboot_multi:
  when: manual
  tags:
    - FWS_WIN_BUILD
  variables:
    TOOLCHAIN_PATH: C:/Users/cydesigner/ModusToolbox/tools_2.3/gcc
    BOARD: CYW20829
    JSON: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_multi.json
  before_script:
    - virtualenv venv
    - source venv/bin/activate
  extends: .20829_build_mcuboot

.mac_20829_build_mcuboot_single:
  when: manual
  tags:
    - FWS_MAC_BUILD
  variables:
    TOOLCHAIN_PATH: /Applications/ModusToolbox/tools_2.3/gcc
    BOARD: CYW20829
    JSON: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single.json
  before_script:
    - virtualenv venv
    - source venv/bin/activate
  extends: .20829_build_mcuboot

.mac_20829_build_mcuboot_multi:
  when: manual
  tags:
    - FWS_MAC_BUILD
  variables:
    TOOLCHAIN_PATH: /Applications/ModusToolbox/tools_2.3/gcc
    BOARD: CYW20829
    JSON: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_multi2.json
  before_script:
    - virtualenv venv
    - source venv/bin/activate
  extends: .20829_build_mcuboot

.lin_20829_build_mcuboot_single:
  when: manual
  tags:
    - FWS_LIN_BUILD
  variables:
    TOOLCHAIN_PATH: /home/fw-security/ModusToolbox/tools_2.3/gcc
    BOARD: CYW20829
    JSON: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single.json
  before_script:
    - virtualenv venv
    - source venv/bin/activate
  extends: .20829_build_mcuboot

.lin_20829_build_mcuboot_multi:
  when: manual
  tags:
    - FWS_LIN_BUILD
  variables:
    TOOLCHAIN_PATH: /home/fw-security/ModusToolbox/tools_2.3/gcc
    BOARD: CYW20829
    JSON: ./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_multi.json
  before_script:
    - virtualenv venv
    - source venv/bin/activate
  extends: .20829_build_mcuboot


######################################################################################################################################
###################################################  C Y W 2 0 8 2 9  P Y T E S T ####################################################
######################################################################################################################################

.cyw20829_test:
  stage: cyw20829_test
  tags:
    - CST_TEST_20829_WIN
  artifacts:
    when: always
    expire_in: 12 weeks
    paths:
      - fwsecurity_test/secure_boot/_logs/**/*
  retry:
    max: 1
  script:
    - $Env:TARGET_ID="170811C800287400"
    - $Env:CI_SERIAL_PORT="COM3"
    - ls "env:"
    - python -V
    - virtualenv venv
    - ./venv/Scripts/activate.ps1
    - python -V
    - pip install git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${CY_SECURETOOLS_BRANCH}
    - pip install git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${TESTAPPS_CYW20829_BRANCH}
    - cysecuretools -v version
    - git clone http://devops-git.aus.cypress.com/repo/fwsecurity_test.git -b ${TEST_BRANCH_20829}
    - cd fwsecurity_test
    - pip install -r requirements.txt
    - cd secure_boot
    - pip install -r secure_boot_req.txt
    - cd ../../boot/cypress
    - python ../../fwsecurity_test/secure_boot/ci_test_executor.py
  after_script:
    - ./venv/Scripts/deactivate
    - rm -r venv

######## SWAP DEBUG ########
cyw20829_swap_normal:
  only:
    - schedules
  variables:
    CIVAR_POLICY: ./policy/policy_no_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_swap
    TEST_SELECT: $TEST_SWAP
  needs:
    - mac_20829_mcuboot_normal_swap
  extends: .cyw20829_test

cyw20829_swap_secure:
  only:
    - schedules
  variables:
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_swap_secure
    TEST_SELECT: $TEST_SWAP
  needs:
    - mac_20829_mcuboot_secure_swap
  extends: .cyw20829_test

cyw20829_swap_secure_enc:
  only:
    - schedules
  variables:
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_swap_secure
    TEST_ENCRYPT: 1
    TEST_SELECT: $TEST_SWAP
  needs:
    - mac_20829_mcuboot_secure_encrypt_swap
  extends: .cyw20829_test

cyw20829_swap_secure_rbc:
  except:
    variables:
      - $COV
      - $CIVAR_MICRO_TEST
      - $CI_COMMIT_TAG
  variables:
    CIVAR_DESTRUCTIVE: 1
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_swap_secure_rbc
    TEST_SELECT: $TEST_RBC
  needs:
    - mac_20829_mcuboot_secure_rollback_swap
  extends: .cyw20829_test

cyw20829_swap_secure_rbc_enc:
  only:
    - schedules
  variables:
    CIVAR_DESTRUCTIVE: 1
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_swap_secure_rbc
    TEST_ENCRYPT: 1
    TEST_SELECT: $TEST_RBC
  needs:
    - mac_20829_mcuboot_secure_encrypt_rollback_swap
  extends: .cyw20829_test


######## OVERWRITE DEBUG ########
cyw20829_overwrite_normal:
  except:
    variables:
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_POLICY: ./policy/policy_no_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE
  needs:
    - mac_20829_mcuboot_normal_overwrite
  extends: .cyw20829_test

cyw20829_overwrite_secure:
  only:
    - schedules
  variables:
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_overwrite_secure
    TEST_SELECT: $TEST_OVERWRITE
  needs:
    - mac_20829_mcuboot_secure_overwrite
  extends: .cyw20829_test

cyw20829_overwrite_secure_enc:
  only:
    - schedules
  variables:
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_overwrite_secure
    TEST_ENCRYPT: 1
    TEST_SELECT: $TEST_OVERWRITE
  needs:
    - mac_20829_mcuboot_secure_encrypt_overwrite
  extends: .cyw20829_test

cyw20829_overwrite_secure_rbc:
  only:
    - schedules
  variables:
    CIVAR_DESTRUCTIVE: 1
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_overwrite_secure_rbc
    TEST_SELECT: $TEST_RBC
  needs:
    - mac_20829_mcuboot_secure_rollback_overwrite
  extends: .cyw20829_test

cyw20829_overwrite_secure_rbc_enc:
  only:
    - schedules
  variables:
    CIVAR_DESTRUCTIVE: 1
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_overwrite_secure_rbc
    TEST_ENCRYPT: 1
    TEST_SELECT: $TEST_RBC
  needs:
    - mac_20829_mcuboot_secure_encrypt_rollback_overwrite
  extends: .cyw20829_test


######## SWAP RELEASE ########
cyw20829_swap_normal_release:
  only:
    - schedules
  variables:
    CIVAR_POLICY: ./policy/policy_no_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_swap
    BUILDCFG: Release
    TEST_SELECT: $TEST_SWAP_RELEASE
  needs:
    - mac_20829_mcuboot_normal_swap
  extends: .cyw20829_test

cyw20829_swap_secure_release:
  only:
    - schedules
  variables:
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_swap_secure
    BUILDCFG: Release
    TEST_SELECT: $TEST_SWAP_RELEASE
  needs:
    - mac_20829_mcuboot_secure_swap
  extends: .cyw20829_test

cyw20829_swap_secure_enc_release:
  except:
    variables:
      - $COV
      - $CI_COMMIT_TAG
  variables:
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_swap_secure
    TEST_ENCRYPT: 1
    BUILDCFG: Release
    TEST_SELECT: $TEST_SWAP_RELEASE
  needs:
    - mac_20829_mcuboot_secure_encrypt_swap
  extends: .cyw20829_test

cyw20829_swap_secure_rbc_release:
  only:
    - schedules
  variables:
    CIVAR_DESTRUCTIVE: 1
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_swap_secure_rbc
    BUILDCFG: Release
    TEST_SELECT: $TEST_RBC_RELEASE
  needs:
    - mac_20829_mcuboot_secure_rollback_swap
  extends: .cyw20829_test

cyw20829_swap_secure_rbc_enc_release:
  only:
    - schedules
  variables:
    CIVAR_DESTRUCTIVE: 1
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_swap_secure_rbc
    TEST_ENCRYPT: 1
    BUILDCFG: Release
    TEST_SELECT: $TEST_RBC_RELEASE
  needs:
    - mac_20829_mcuboot_secure_encrypt_rollback_swap
  extends: .cyw20829_test


######## OVERWRITE RELEASE ########
cyw20829_overwrite_normal_release:
  only:
    - schedules
  variables:
    CIVAR_POLICY: ./policy/policy_no_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_overwrite
    BUILDCFG: Release
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
  needs:
    - mac_20829_mcuboot_normal_overwrite
  extends: .cyw20829_test

cyw20829_overwrite_secure_release:
  only:
    - schedules
  variables:
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_overwrite_secure
    BUILDCFG: Release
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
  needs:
    - mac_20829_mcuboot_secure_overwrite
  extends: .cyw20829_test

cyw20829_overwrite_secure_enc_release:
  only:
    - schedules
  variables:
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_overwrite_secure
    TEST_ENCRYPT: 1
    BUILDCFG: Release
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
  needs:
    - mac_20829_mcuboot_secure_encrypt_overwrite
  extends: .cyw20829_test

cyw20829_overwrite_secure_rbc_release:
  only:
    - schedules
  variables:
    CIVAR_DESTRUCTIVE: 1
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_overwrite_secure_rbc
    BUILDCFG: Release
    TEST_SELECT: $TEST_RBC_RELEASE
  needs:
    - mac_20829_mcuboot_secure_rollback_overwrite
  extends: .cyw20829_test

cyw20829_overwrite_secure_rbc_enc_release:
  only:
    - schedules
  variables:
    CIVAR_DESTRUCTIVE: 1
    CIVAR_POLICY: ./policy/policy_secure.json
    TEST_CONFIG: CI_MCUBoot_20829_single_overwrite_secure_rbc
    TEST_ENCRYPT: 1
    BUILDCFG: Release
    TEST_SELECT: $TEST_RBC_RELEASE
  needs:
    - mac_20829_mcuboot_secure_encrypt_rollback_overwrite
  extends: .cyw20829_test

######################################################################################################################################
################################################  C Y W 2 0 8 2 9  B A S E  T E S T  #################################################
######################################################################################################################################

.cyw20829_base_test:
  stage: cyw20829_test
  tags:
    - CST_TEST_20829_WIN
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  artifacts:
    when: always
    expire_in: 12 weeks
    paths:
      - cy_boot_test_suite/test_tools/ci/20829/test_output.log
  script:
    - python -V
    - virtualenv venv
    - ./venv/Scripts/activate.ps1
    - python -V
    - git clone http://git-ore.aus.cypress.com/YNCI/cy_boot_test_suite.git -b $TEST_BRANCH_20829
    - cd cy_boot_test_suite/test_tools/ci/20829
    - pip install -r requirements.txt
    - pip install git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${CY_SECURETOOLS_BRANCH}
    - pip install git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${TESTAPPS_CYW20829_BRANCH}
    - cysecuretools -v version
    - python 20829_test.py
  after_script:
    - ./venv/Scripts/deactivate
    - rm -r venv

.win_cyw20829_base_test_single:
  needs:
    - win_20829_build_blinky
    - win_20829_build_mcuboot_single
  extends: .cyw20829_base_test

.mac_cyw20829_base_test_single:
  needs:
    - mac_20829_build_blinky
    - mac_20829_build_mcuboot_single
  extends: .cyw20829_base_test

.lin_cyw20829_base_test_single:
  needs:
    - lin_20829_build_blinky
    - lin_20829_build_mcuboot_single
  extends: .cyw20829_base_test

.win_cyw20829_base_test_multi:
  needs:
    - win_20829_build_blinky
    - win_20829_build_mcuboot_multi
  extends: .cyw20829_base_test

.mac_cyw20829_base_test_multi:
  needs:
    - mac_20829_build_blinky
    - mac_20829_build_mcuboot_multi
  extends: .cyw20829_base_test

.lin_cyw20829_base_test_multi:
  needs:
    - lin_20829_build_blinky
    - lin_20829_build_mcuboot_multi
  extends: .cyw20829_base_test

######################################################################################################################################
#######################################################  B L I N K Y  A P P S ########################################################
######################################################################################################################################

################################################### 5 1 2 K  B L I N K Y  A P P S ####################################################

512k_blinky_boot:
  stage: build_blinky
  variables:
    PSOC: 512K
    TYPE: BOOT
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
    IMG_ID: 1
  extends: .build_blinky

512k_blinky_upgrade:
  stage: build_blinky
  variables:
    PSOC: 512K
    TYPE: UPGRADE
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
    IMG_ID: 1
  extends: .build_blinky

512k_blinky_upgrade_smif:
  stage: build_blinky
  variables:
    PSOC: 512K
    TYPE: UPGRADE
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single_smif.json
    IMG_ID: 1
  extends: .build_blinky

##################################################### 1 M  B L I N K Y  A P P S ######################################################

1m_blinky_boot:
  stage: build_blinky
  variables:
    PSOC: 1M
    TYPE: BOOT
    IMG_ID: 1
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
  extends: .build_blinky

1m_blinky_upgrade:
  stage: build_blinky
  variables:
    PSOC: 1M
    TYPE: UPGRADE
    IMG_ID: 1
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
  extends: .build_blinky

1m_blinky_upgrade_smif:
  stage: build_blinky
  variables:
    PSOC: 1M
    TYPE: UPGRADE
    IMG_ID: 1
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single_smif.json
  extends: .build_blinky

##################################################### 2 M  B L I N K Y  A P P S ######################################################

2m_blinky_boot:
  stage: build_blinky
  variables:
    PSOC: 2M
    TYPE: BOOT
    IMG_ID: 1
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
  extends: .build_blinky

2m_blinky_upgrade:
  stage: build_blinky
  variables:
    PSOC: 2M
    TYPE: UPGRADE
    IMG_ID: 1
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
  extends: .build_blinky

2m_blinky_upgrade_smif:
  stage: build_blinky
  variables:
    PSOC: 2M
    TYPE: UPGRADE
    IMG_ID: 1
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single_smif.json
  extends: .build_blinky

######################################################################################################################################
################################################## M C U B O O T   S W A P   M O D E #################################################
######################################################################################################################################

############################################# M C U B O O T   5 1 2 K   S W A P   M O D E ############################################

512k_mcuboot_single_swap:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
    PSOC: 512K
    ENCRYPT: 0
  extends: .build_mcuboot

512k_mcuboot_single_smif_swap:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single_smif.json
    PSOC: 512K
    ENCRYPT: 0
  extends: .build_mcuboot

512k_mcuboot_multi_swap:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_multi.json
    PSOC: 512K
    ENCRYPT: 0
  extends: .build_mcuboot

.512k_mcuboot_multi_smif_swap:
  when: manual
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_multi_smif.json
    PSOC: 512K
    ENCRYPT: 0
  extends: .build_mcuboot

############################################### M C U B O O T   1 M   S W A P   M O D E ##############################################

1m_mcuboot_single_swap:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
    PSOC: 1M
    ENCRYPT: 0
  extends: .build_mcuboot

1m_mcuboot_single_smif_swap:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single_smif.json
    PSOC: 1M
    ENCRYPT: 0
  extends: .build_mcuboot

1m_mcuboot_multi_swap:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_multi.json
    PSOC: 1M
    ENCRYPT: 0
  extends: .build_mcuboot

1m_mcuboot_multi_smif_swap:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_multi_smif.json
    PSOC: 1M
    ENCRYPT: 0
  extends: .build_mcuboot

############################################### M C U B O O T   2 M   S W A P   M O D E ##############################################

2m_mcuboot_single_swap:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
    PSOC: 2M
    ENCRYPT: 0
  extends: .build_mcuboot

2m_mcuboot_single_smif_swap:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single_smif.json
    PSOC: 2M
    ENCRYPT: 0
  extends: .build_mcuboot

2m_mcuboot_multi_swap:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_multi.json
    PSOC: 2M
    ENCRYPT: 0
  extends: .build_mcuboot

2m_mcuboot_multi_smif_swap:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_multi_smif.json
    PSOC: 2M
    ENCRYPT: 0
  extends: .build_mcuboot

######################################################################################################################################
######################################## M C U B O O T   5 1 2 K   O V E R W R I T E   M O D E #######################################
######################################################################################################################################

######################################## M C U B O O T   5 1 2 K   O V E R W R I T E   M O D E #######################################

512k_mcuboot_single_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single.json
    PSOC: 512K
    ENCRYPT: 0
  extends: .build_mcuboot

512k_mcuboot_single_smif_overwrite:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single_smif.json
    PSOC: 512K
    ENCRYPT: 0
  extends: .build_mcuboot

512k_mcuboot_multi_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi.json
    PSOC: 512K
    ENCRYPT: 0
  extends: .build_mcuboot

.512k_mcuboot_multi_smif_overwrite:
  when: manual
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi_smif.json
    PSOC: 512K
    ENCRYPT: 0
  extends: .build_mcuboot

########################################## M C U B O O T   1 M   O V E R W R I T E   M O D E #########################################

1m_mcuboot_single_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single.json
    PSOC: 1M
    ENCRYPT: 0
  extends: .build_mcuboot

1m_mcuboot_single_smif_overwrite:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single_smif.json
    PSOC: 1M
    ENCRYPT: 0
  extends: .build_mcuboot

1m_mcuboot_multi_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi.json
    PSOC: 1M
    ENCRYPT: 0
  extends: .build_mcuboot

1m_mcuboot_multi_smif_overwrite:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi_smif.json
    PSOC: 1M
    ENCRYPT: 0
  extends: .build_mcuboot

########################################## M C U B O O T   2 M   O V E R W R I T E   M O D E #########################################

2m_mcuboot_single_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single.json
    PSOC: 2M
    ENCRYPT: 0
  extends: .build_mcuboot

2m_mcuboot_single_smif_overwrite:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single_smif.json
    PSOC: 2M
    ENCRYPT: 0
  extends: .build_mcuboot

2m_mcuboot_multi_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi.json
    PSOC: 2M
    ENCRYPT: 0
  extends: .build_mcuboot

2m_mcuboot_multi_smif_overwrite:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi_smif.json
    PSOC: 2M
    ENCRYPT: 0
  extends: .build_mcuboot

######################################################################################################################################
################################ M C U B O O T   5 1 2 K   E N C R Y P T   O V E R W R I T E   M O D E ###############################
######################################################################################################################################

######################################## M C U B O O T   5 1 2 K   O V E R W R I T E   M O D E #######################################

512k_mcuboot_single_encrypt_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single.json
    PSOC: 512K
    ENCRYPT: 1
  extends: .build_mcuboot

512k_mcuboot_single_smif_encrypt_overwrite:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single_smif.json
    PSOC: 512K
    ENCRYPT: 1
  extends: .build_mcuboot

512k_mcuboot_multi_encrypt_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi.json
    PSOC: 512K
    ENCRYPT: 1
  extends: .build_mcuboot

.512k_mcuboot_multi_smif_encrypt_overwrite:
  when: manual
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi_smif.json
    PSOC: 512K
    ENCRYPT: 1
  extends: .build_mcuboot

########################################## M C U B O O T   1 M   O V E R W R I T E   M O D E #########################################

1m_mcuboot_single_encrypt_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single.json
    PSOC: 1M
    ENCRYPT: 1
  extends: .build_mcuboot

1m_mcuboot_single_smif_encrypt_overwrite:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single_smif.json
    PSOC: 1M
    ENCRYPT: 1
  extends: .build_mcuboot

1m_mcuboot_multi_encrypt_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi.json
    PSOC: 1M
    ENCRYPT: 1
  extends: .build_mcuboot

1m_mcuboot_multi_smif_encrypt_overwrite:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi_smif.json
    PSOC: 1M
    ENCRYPT: 1
  extends: .build_mcuboot

########################################## M C U B O O T   2 M   O V E R W R I T E   M O D E #########################################

2m_mcuboot_single_encrypt_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single.json
    PSOC: 2M
    ENCRYPT: 1
  extends: .build_mcuboot

2m_mcuboot_single_smif_encrypt_overwrite:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single_smif.json
    PSOC: 2M
    ENCRYPT: 1
  extends: .build_mcuboot

2m_mcuboot_multi_encrypt_overwrite:
  stage: build_mcuboot
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi.json
    PSOC: 2M
    ENCRYPT: 1
  extends: .build_mcuboot

2m_mcuboot_multi_smif_encrypt_overwrite:
  stage: build_mcuboot_smif
  variables:
    JSON: ./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_multi_smif.json
    PSOC: 2M
    ENCRYPT: 1
  extends: .build_mcuboot

######################################################################################################################################
################################################# S W A P  5 1 2 K  T E S T S ########################################################
######################################################################################################################################

512k_single_swap:
  extends: .512k_swap
  needs:
    - 512k_mcuboot_single_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_swap
    TEST_SELECT: $TEST_SWAP

512k_single_smif_swap:
  extends: .512k_swap
  needs:
    - 512k_mcuboot_single_smif_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_smif_swap
    TEST_SELECT: $TEST_SWAP

512k_multi_app1_swap:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi1_swap
    TEST_SELECT: $TEST_SWAP

512k_multi_app2_swap:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap

512k_single_swap_release:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_single_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

512k_single_smif_swap_release:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_single_smif_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_smif_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

512k_multi_app1_swap_release:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi1_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

512k_multi_app2_swap_release:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap
    BUILDCFG_TEST: Release

######################################################################################################################################
################################################### S W A P  1 M  T E S T S ##########################################################
######################################################################################################################################

1m_single_swap:
  extends: .1m_swap
  needs:
    - 1m_mcuboot_single_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_swap
    TEST_SELECT: $TEST_SWAP

1m_single_smif_swap:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_smif_swap
    TEST_SELECT: $TEST_SWAP

1m_multi_app1_swap:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_swap
    TEST_SELECT: $TEST_SWAP

1m_multi_app2_swap:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap

1m_multi_app1_smif_swap:
  extends: .1m_swap
  needs:
    - 1m_mcuboot_multi_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_smif_swap
    TEST_SELECT: $TEST_SWAP

1m_multi_app2_smif_swap:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_smif_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap

1m_single_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

1m_single_smif_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_smif_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

1m_multi_app1_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

1m_multi_app2_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap
    BUILDCFG_TEST: Release

1m_multi_app1_smif_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_smif_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

1m_multi_app2_smif_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_smif_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap
    BUILDCFG_TEST: Release

######################################################################################################################################
################################################### S W A P  2 M  T E S T S ##########################################################
######################################################################################################################################

2m_eval_multi_app1_smif_swap_release:
  extends: .2m_eval_swap
  needs:
    - 2m_mcuboot_multi_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_smif_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

2m_single_swap:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_swap
    TEST_SELECT: $TEST_SWAP

2m_single_smif_swap:
  extends: .2m_swap
  needs:
    - 2m_mcuboot_single_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_smif_swap
    TEST_SELECT: $TEST_SWAP

2m_multi_app1_swap:
  extends: .2m_swap
  needs:
    - 2m_mcuboot_multi_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_swap
    TEST_SELECT: $TEST_SWAP

2m_multi_app2_swap:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap

2m_multi_app1_smif_swap:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_smif_swap
    TEST_SELECT: $TEST_SWAP

2m_multi_app2_smif_swap:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_smif_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap

2m_single_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

2m_single_smif_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_smif_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app1_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app2_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap
    BUILDCFG_TEST: Release

2m_multi_app1_smif_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_smif_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app2_smif_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_smif_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap
    BUILDCFG_TEST: Release

######################################################################################################################################
############################################# O V E R W R I T E  512 K  T E S T S ####################################################
######################################################################################################################################

512k_single_overwrite:
  extends: .512k_overwrite
  needs:
    - 512k_mcuboot_single_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE

512k_single_smif_overwrite:
  extends: .512k_overwrite
  needs:
    - 512k_mcuboot_single_smif_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

512k_multi1_overwrite:
  extends: .512k_overwrite
  needs:
    - 512k_mcuboot_multi_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE

512k_multi2_overwrite:
  extends: .512k_overwrite
  needs:
    - 512k_mcuboot_multi_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi2_overwrite
    TEST_SELECT: $TEST_SWAP

512k_single_overwrite_release:
  extends: .512k_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_single_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

512k_single_smif_overwrite_release:
  extends: .512k_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_single_smif_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

512k_multi1_overwrite_release:
  extends: .512k_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

512k_multi2_overwrite_release:
  extends: .512k_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

###################################### O V E R W R I T E  5 1 2 K  T E S T S   E N C R Y P T #########################################

512k_single_encrypt_overwrite:
  extends: .512k_encrypt_overwrite
  needs:
    - 512k_mcuboot_single_encrypt_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE

512k_single_smif_encrypt_overwrite:
  extends: .512k_encrypt_overwrite
  needs:
    - 512k_mcuboot_single_smif_encrypt_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

512k_multi1_encrypt_overwrite:
  extends: .512k_encrypt_overwrite
  needs:
    - 512k_mcuboot_multi_encrypt_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE

512k_multi2_encrypt_overwrite:
  extends: .512k_encrypt_overwrite
  needs:
    - 512k_mcuboot_multi_encrypt_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi2_overwrite
    TEST_SELECT: $TEST_SWAP

512k_single_encrypt_overwrite_release:
  extends: .512k_encrypt_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_single_encrypt_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

512k_single_smif_encrypt_overwrite_release:
  extends: .512k_encrypt_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_single_smif_encrypt_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

512k_multi1_encrypt_overwrite_release:
  extends: .512k_encrypt_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_encrypt_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

512k_multi2_encrypt_overwrite_release:
  extends: .512k_encrypt_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_encrypt_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

######################################################################################################################################
############################################## O V E R W R I T E  1 M  T E S T S #####################################################
######################################################################################################################################

1m_single_overwrite:
  extends: .1m_overwrite
  needs:
    - 1m_mcuboot_single_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_single_smif_overwrite:
  extends: .1m_overwrite
  needs:
    - 1m_mcuboot_single_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_multi1_overwrite:
  extends: .1m_overwrite
  needs:
    - 1m_mcuboot_multi_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_multi2_overwrite:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_multi1_smif_overwrite:
  extends: .1m_overwrite
  needs:
    - 1m_mcuboot_multi_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_multi2_smif_overwrite:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_single_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_single_smif_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi1_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi2_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi1_smif_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi2_smif_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

###################################### O V E R W R I T E  1 M  T E S T S   E N C R Y P T #############################################

1m_single_encrypt_overwrite:
  extends: .1m_encrypt_overwrite
  needs:
    - 1m_mcuboot_single_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_single_smif_encrypt_overwrite:
  extends: .1m_encrypt_overwrite
  needs:
    - 1m_mcuboot_single_smif_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_multi1_encrypt_overwrite:
  extends: .1m_encrypt_overwrite
  needs:
    - 1m_mcuboot_multi_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_multi2_encrypt_overwrite:
  extends: .1m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_multi1_smif_encrypt_overwrite:
  extends: .1m_encrypt_overwrite
  needs:
    - 1m_mcuboot_multi_smif_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_multi2_smif_encrypt_overwrite:
  extends: .1m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_single_encrypt_overwrite_release:
  extends: .1m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_single_smif_encrypt_overwrite_release:
  extends: .1m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_smif_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi1_encrypt_overwrite_release:
  extends: .1m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi2_encrypt_overwrite_release:
  extends: .1m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi1_smif_encrypt_overwrite_release:
  extends: .1m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi2_smif_encrypt_overwrite_release:
  extends: .1m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_encrypt_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

######################################################################################################################################
############################################## O V E R W R I T E  2 M  T E S T S #####################################################
######################################################################################################################################

2m_single_overwrite:
  extends: .2m_overwrite
  needs:
    - 2m_mcuboot_single_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_single_smif_overwrite:
  extends: .2m_overwrite
  needs:
    - 2m_mcuboot_single_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app1_overwrite:
  extends: .2m_overwrite
  needs:
    - 2m_mcuboot_multi_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app2_overwrite:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app1_smif_overwrite:
  extends: .2m_overwrite
  needs:
    - 2m_mcuboot_multi_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app2_smif_overwrite:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_single_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_single_smif_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app1_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app2_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app1_smif_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app2_smif_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

###################################### O V E R W R I T E  2 M  T E S T S   E N C R Y P T #############################################

2m_single_encrypt_overwrite:
  extends: .2m_encrypt_overwrite
  needs:
    - 2m_mcuboot_single_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_single_smif_encrypt_overwrite:
  extends: .2m_encrypt_overwrite
  needs:
    - 2m_mcuboot_single_smif_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app1_encrypt_overwrite:
  extends: .2m_encrypt_overwrite
  needs:
    - 2m_mcuboot_multi_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app2_encrypt_overwrite:
  extends: .2m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app1_smif_encrypt_overwrite:
  extends: .2m_encrypt_overwrite
  needs:
    - 2m_mcuboot_multi_smif_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app2_smif_encrypt_overwrite:
  extends: .2m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_single_encrypt_overwrite_release:
  extends: .2m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_single_smif_encrypt_overwrite_release:
  extends: .2m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_smif_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app1_encrypt_overwrite_release:
  extends: .2m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app2_encrypt_overwrite_release:
  extends: .2m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app1_smif_encrypt_overwrite_release:
  extends: .2m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app2_smif_encrypt_overwrite_release:
  extends: .2m_encrypt_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_encrypt_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

######################################################################################################################################
######################################################### S I M U L A T O R ##########################################################
######################################################################################################################################

MCUboot_simulator_basic:
  stage: mcuboot_simulator
  needs: []
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  tags:
    - MCUBOOT_SIMULATOR_20.04.3
  script:
    - git submodule deinit --all -f
    - git submodule sync --recursive
    - git submodule update --init --recursive
    - cd sim
    - cargo test $SIM_ARG

MCUboot_simulator_PSoC6_swap_status:
  stage: mcuboot_simulator
  needs: []
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  tags:
    - MCUBOOT_SIMULATOR_20.04.3
  script:
    - git submodule sync --recursive
    - git submodule update --init --recursive
    - cd sim
    - cargo test --features overwrite-only
    - cargo test --features swap-status -- --test-threads=1

.simulator:
  stage: mcuboot_simulator
  needs: []
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $CI_COMMIT_TAG
  tags:
    - MCUBOOT_SIMULATOR_20.04.3
  script:
    - git submodule deinit --all -f
    - git submodule sync --recursive
    - git submodule update --init --recursive
    - echo Simulator features = $MULTI_FEATURES
    - ./ci/sim_run.sh

MCUboot_simulator_encryption_features:
  variables:
    MULTI_FEATURES: 'enc-rsa,enc-kw,enc-ec256,enc-x25519'
  extends: .simulator

MCUboot_simulator_all_features_separately:
  variables:
    MULTI_FEATURES: 'overwrite-only,swap-move,validate-primary-slot,bootstrap,multiimage,large-write overwrite-only,downgrade-prevention overwrite-only,sig-rsa,sig-rsa3072,sig-ecdsa,sig-ecdsa-mbedtls,sig-ed25519'
  extends: .simulator

.simulator_common:
  only:
    - schedules
  extends: .simulator

MCUboot_simulator_github_flow 1/21:
  variables:
    MULTI_FEATURES: 'sig-ecdsa,sig-ecdsa-mbedtls,sig-ed25519,enc-kw,bootstrap'
  extends: .simulator_common

MCUboot_simulator_github_flow 2/21:
  variables:
    MULTI_FEATURES: 'sig-rsa,sig-rsa3072,overwrite-only,validate-primary-slot,swap-move'
  extends: .simulator_common

MCUboot_simulator_github_flow 3/21:
  variables:
    MULTI_FEATURES: 'enc-rsa'
  extends: .simulator_common

MCUboot_simulator_github_flow 4/21:
  variables:
    MULTI_FEATURES_UNSUPPORTED: 'enc-aes256-rsa'
  extends: .simulator_common

MCUboot_simulator_github_flow 5/21:
  variables:
    MULTI_FEATURES: 'enc-ec256'
  extends: .simulator_common

MCUboot_simulator_github_flow 6/21:
  variables:
    MULTI_FEATURES_UNSUPPORTED: 'enc-aes256-ec256'
  extends: .simulator_common

MCUboot_simulator_github_flow 7/21:
  variables:
    MULTI_FEATURES: 'enc-x25519'
  extends: .simulator_common

MCUboot_simulator_github_flow 8/21:
  variables:
    MULTI_FEATURES_UNSUPPORTED: 'enc-aes256-x25519'
  extends: .simulator_common

MCUboot_simulator_github_flow 9/21:
  variables:
    MULTI_FEATURES: 'sig-rsa overwrite-only large-write,sig-ecdsa overwrite-only large-write,sig-ecdsa-mbedtls overwrite-only large-write,multiimage overwrite-only large-write'
  extends: .simulator_common

MCUboot_simulator_github_flow 10/21:
  variables:
    MULTI_FEATURES: 'sig-rsa validate-primary-slot,sig-ecdsa validate-primary-slot,sig-ecdsa-mbedtls validate-primary-slot,sig-rsa multiimage validate-primary-slot'
  extends: .simulator_common

MCUboot_simulator_github_flow 11/21:
  variables:
    MULTI_FEATURES: 'enc-kw overwrite-only large-write,enc-rsa overwrite-only large-write'
  extends: .simulator_common

MCUboot_simulator_github_flow 12/21:
  variables:
    MULTI_FEATURES_UNSUPPORTED: 'enc-aes256-kw overwrite-only large-write,enc-rsa overwrite-only large-write'
  extends: .simulator_common

MCUboot_simulator_github_flow 13/21:
  variables:
    MULTI_FEATURES: 'sig-rsa enc-rsa validate-primary-slot,swap-move enc-rsa sig-rsa validate-primary-slot bootstrap'
  extends: .simulator_common

MCUboot_simulator_github_flow 14/21:
  variables:
    MULTI_FEATURES: 'sig-rsa enc-kw validate-primary-slot bootstrap,sig-ed25519 enc-x25519 validate-primary-slot'
  extends: .simulator_common

MCUboot_simulator_github_flow 15/21:
  variables:
    MULTI_FEATURES: 'sig-ecdsa enc-kw validate-primary-slot'
  extends: .simulator_common

MCUboot_simulator_github_flow 16/21:
  variables:
    MULTI_FEATURES: 'sig-ecdsa-mbedtls enc-kw validate-primary-slot'
  extends: .simulator_common

MCUboot_simulator_github_flow 17/21:
  variables:
    MULTI_FEATURES: 'sig-rsa validate-primary-slot overwrite-only large-write'
  extends: .simulator_common

MCUboot_simulator_github_flow 18/21:
  variables:
    MULTI_FEATURES: 'sig-ecdsa enc-ec256 validate-primary-slot'
  extends: .simulator_common

MCUboot_simulator_github_flow 19/21:
  variables:
    MULTI_FEATURES: 'sig-ecdsa-mbedtls validate-primary-slot'
    MULTI_FEATURES_UNSUPPORTED: 'sig-ecdsa-mbedtls enc-ec256-mbedtls validate-primary-slot'
  extends: .simulator_common

MCUboot_simulator_github_flow 20/21:
  variables:
    MULTI_FEATURES_UNSUPPORTED: 'sig-ecdsa-mbedtls enc-aes256-ec256 validate-primary-slot'
  extends: .simulator_common

MCUboot_simulator_github_flow 21/21:
  variables:
    MULTI_FEATURES: 'sig-rsa validate-primary-slot overwrite-only downgrade-prevention'
  extends: .simulator_common

######################################################################################################################################
########################################################## C P P C H E C K ###########################################################
######################################################################################################################################

cppcheck_20829:
  stage: code_quality_check
  tags:
    - MCU_CPPCHECK
  needs: []
  variables:
    GIT_STRATEGY: clone
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $REPO
      - $CI_COMMIT_TAG
  artifacts:
    when: always
    expire_in: 4 weeks
    paths:
      - boot/cypress/cppcheck/MCUBootApp/results
  script:
    - cppcheck --version
    - git submodule deinit --all -f
    - git submodule sync --recursive
    - git submodule update --init --recursive
    - cd boot/cypress
    - $PSDefaultParameterValues = @{"Out-File:Encoding"="ASCII"}
    - python scripts/flashmap.py -p PSOC_062_2M -i ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json -o ./cy_flash_pal/cy_flash_map.h > ./MCUBootApp/flashmap.mk
    - time make run_cppcheck PLATFORM=CYW20829 APP_NAME=MCUBootApp CPP_CHECK_SCOPE=all BUILDCFG=Debug FLASH_MAP=./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single_psvp.json
    - time make run_cppcheck PLATFORM=CYW20829 APP_NAME=MCUBootApp CPP_CHECK_SCOPE=all BUILDCFG=Release FLASH_MAP=./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single_psvp.json

cppcheck_PSOC6:
  stage: code_quality_check
  tags:
    - MCU_CPPCHECK
  needs: []
  variables:
    GIT_STRATEGY: clone
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $REPO
      - $CI_COMMIT_TAG
  artifacts:
    when: always
    expire_in: 4 weeks
    paths:
      - boot/cypress/cppcheck/MCUBootApp/results
  script:
    - cppcheck --version
    - git submodule deinit --all -f
    - git submodule sync --recursive
    - git submodule update --init --recursive
    - cd boot/cypress
    - $PSDefaultParameterValues = @{"Out-File:Encoding"="ASCII"}
    - python scripts/flashmap.py -p PSOC_062_2M -i ./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json -o ./cy_flash_pal/cy_flash_map.h > ./MCUBootApp/flashmap.mk
    - make run_cppcheck PLATFORM=PSOC_062_2M APP_NAME=MCUBootApp CPP_CHECK_SCOPE=all BUILDCFG=Release FLASH_MAP=./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
    - make run_cppcheck PLATFORM=PSOC_062_1M APP_NAME=MCUBootApp CPP_CHECK_SCOPE=all BUILDCFG=Debug FLASH_MAP=./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
    - time make run_cppcheck PLATFORM=PSOC_062_512K APP_NAME=MCUBootApp CPP_CHECK_SCOPE=all BUILDCFG=Release FLASH_MAP=./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json

#######################################################################################################################################################
# Coverity MISRA 2012 & CERT C check
#######################################################################################################################################################
.coverity_common:
  stage: code_quality_check
  tags:
    - SFB-CI-COV-001
  needs: []
  variables:
    GIT_STRATEGY: clone
    COVERITY_PATH: '.\ci\coverity'
  artifacts:
    paths:
      - $COVERITY_PATH\*.log
      - $COVERITY_PATH\violations.csv
    expire_in: 4 weeks
    when: always
  script:
    - git submodule sync --recursive
    - git submodule update --init --recursive
    - git clone http://devops-git.aus.cypress.com/dmxh/coverity -b $COVERITY_BRANCH $COVERITY_PATH 
    - pushd $COVERITY_PATH
    - python -V
    - python -m virtualenv venv
    - ./venv/Scripts/activate.ps1
    - pip install -r requirements.txt
    - pip install git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@$CY_SECURETOOLS_BRANCH
    - cysecuretools -v version
    - python check_coverity.py -c $CI_COVERITY_CONFIG_FILE
  after_script:
    - 'cat ci\coverity\$CI_COVERITY_LOG_FILE | cut -c 45- | grep -e "| MANDATORY |" -e " | REQUIRED | " -e " | L1 | "  -e " | L2 | " | sort | nl | sed -e "s/MISRA/| MISRA/g" | sed -e "s/violations/| violations/g" | tee ci\coverity\violations.csv'


coverity_misra_20829_default:
  when: manual
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_misra_20829_full.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/all_files/config_mcuboot_misra.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=CYW20829 FLASH_MAP=./cy_flash_pal/flash_cyw208xx/flashmap/cyw20829_xip_swap_single_psvp.json
  extends: .coverity_common

coverity_misra_20829_ow_release:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_misra_20829_ow.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/cyw20829/config_mcuboot_misra.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=CYW20829 BUILDCFG=Release USE_EXTERNAL_FLASH=1 ENC_IMG=1 LCS=SECURE USE_OVERWRITE=1 FLASH_MAP=./cy_flash_pal/flash_cyw208xx/flashmap/hw_rollback_prot/cyw20829_xip_overwrite_single_psvp.json
  extends: .coverity_common

coverity_misra_20829_swap_debug:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_misra_20829_swap.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/cyw20829/config_mcuboot_misra.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=CYW20829 BUILDCFG=Debug USE_EXTERNAL_FLASH=1 ENC_IMG=1 LCS=SECURE USE_OVERWRITE=0 FLASH_MAP=./cy_flash_pal/flash_cyw208xx/flashmap/hw_rollback_prot/cyw20829_xip_swap_single_psvp.json
  extends: .coverity_common

coverity_misra_062_2m:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_misra_062_2m.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/psoc062/config_mcuboot_misra.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=PSOC_062_2M BUILDCFG=Release MCUBOOT_IMAGE_NUMBER=2 USE_EXTERNAL_FLASH=1 USE_OVERWRITE=0 ENC_IMG=1 FLASH_MAP=./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_multi_smif.json
  extends: .coverity_common

coverity_misra_062_1m:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_misra_062_1m.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/psoc062/config_mcuboot_misra.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=PSOC_062_1M BUILDCFG=Debug MCUBOOT_IMAGE_NUMBER=1 USE_EXTERNAL_FLASH=0 USE_OVERWRITE=0 ENC_IMG=0 FLASH_MAP=./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
  extends: .coverity_common

coverity_misra_062_512k:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_misra_062_512k.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/psoc062/config_mcuboot_misra.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=PSOC_062_512K BUILDCFG=Release MCUBOOT_IMAGE_NUMBER=1 USE_EXTERNAL_FLASH=1 USE_OVERWRITE=1 ENC_IMG=1 FLASH_MAP=./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single_smif.json
  extends: .coverity_common


coverity_certc_062_2m_default:
  when: manual
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_certc_062_2m_full.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/all_files/config_mcuboot_cert_c.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=PSOC_062_2M FLASH_MAP=./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
  extends: .coverity_common

coverity_certc_20829_ow_release:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_certc_20829_ow.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/cyw20829/config_mcuboot_cert_c.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=CYW20829 BUILDCFG=Release USE_EXTERNAL_FLASH=1 ENC_IMG=1 LCS=SECURE USE_OVERWRITE=1 FLASH_MAP=./cy_flash_pal/flash_cyw208xx/flashmap/hw_rollback_prot/cyw20829_xip_overwrite_single_psvp.json
  extends: .coverity_common

coverity_certc_20829_swap_debug:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_certc_20829_swap.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/cyw20829/config_mcuboot_cert_c.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=CYW20829 BUILDCFG=Debug USE_EXTERNAL_FLASH=1 ENC_IMG=1 LCS=SECURE USE_OVERWRITE=0 FLASH_MAP=./cy_flash_pal/flash_cyw208xx/flashmap/hw_rollback_prot/cyw20829_xip_swap_single_psvp.json
  extends: .coverity_common

coverity_certc_062_2m:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_certc_062_2m.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/psoc062/config_mcuboot_cert_c.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=PSOC_062_2M BUILDCFG=Release MCUBOOT_IMAGE_NUMBER=2 USE_EXTERNAL_FLASH=1 USE_OVERWRITE=0 ENC_IMG=1 FLASH_MAP=./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_multi_smif.json
  extends: .coverity_common

coverity_certc_062_1m:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $COV
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_certc_062_1m.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/psoc062/config_mcuboot_cert_c.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=PSOC_062_1M BUILDCFG=Debug MCUBOOT_IMAGE_NUMBER=1 USE_EXTERNAL_FLASH=0 USE_OVERWRITE=0 ENC_IMG=0 FLASH_MAP=./cy_flash_pal/flash_psoc6/flashmap/psoc62_swap_single.json
  extends: .coverity_common

coverity_certc_062_512k:
  except:
    variables:
      - $CIVAR_MICRO_TEST
      - $REPO
      - $CI_COMMIT_TAG
  variables:
    CI_COVERITY_LOG_FILE: coverity_certc_062_512k.log
    CI_COVERITY_CONFIG_FILE: ./../../boot/cypress/coverity/psoc062/config_mcuboot_cert_c.json
    CI_COVERITY_BUILD_CMD: make clean app POST_BUILD_ENABLE=0 APP_NAME=MCUBootApp PLATFORM=PSOC_062_512K BUILDCFG=Release MCUBOOT_IMAGE_NUMBER=1 USE_EXTERNAL_FLASH=1 USE_OVERWRITE=1 ENC_IMG=1 FLASH_MAP=./cy_flash_pal/flash_psoc6/flashmap/psoc62_overwrite_single_smif.json
  extends: .coverity_common
