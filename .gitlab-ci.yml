stages:
  - build_blinky
  - build_mcuboot_smif
  - build_mcuboot
  - 512k_swap_tests
  - 1m_swap_tests
  - 2m_swap_tests
  - 512k_overwrite_tests
  - 1m_overwrite_tests
  - 2m_overwrite_tests
  - checks

variables:
  # MCUBoot/Bootloader test selectors. Can be overwriten by CI variables.
  # TWO_TESTS - minimal boot/upgrade positive tests
  # THREE_TESTS - two positive and one negative test
  # SMOKE - short basic tests with swap (optional)
  # OVERNIGHT - extended tests for overnight pipeline
  # ALL - complete set of all suite tests
  # CUSTOM - manualy selected tests in MCUBoot suite repository

    TEST_SWAP: SMOKE
    TEST_SWAP_RELEASE: SMOKE

    TEST_OVERWRITE: SMOKE
    TEST_OVERWRITE_RELEASE: SMOKE

  # Skip all following tests when fail
    ERREXIT: 'True'

  # Branch or tag seletct for test suite
    TEST_BRANCH: feature/062_swap_all

  # Branch with CppCheck scripts and config
    CPPCHECK_BRANCH: pr/cypress-mcuboot-cppcheck

  # DO NOT EDIT. Internal CI runner tools path
    OBJCOPY_PATH: C:/Users/cydesigner/ModusToolbox/tools_2.0/gcc-7.2.1/bin/arm-none-eabi-objcopy
    OPENOCD_PATH: C:/Users/cydesigner/ModusToolbox/tools_2.0/openocd
    TOOLCHAIN_PATH: /home/fw-security/ModusToolbox/tools_2.0/gcc-7.2.1

#######################################################################################################################################
##################################################### C O M M O N   E X T E N D S #####################################################
#######################################################################################################################################

.build_blinky:
  tags:
    - FWS_LIN_BUILD
  needs: []
  except:
    - tags
  artifacts:
    expire_in: 4 weeks
    paths:
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Debug/${TYPE,,}/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Release/${TYPE,,}/BlinkyApp.elf
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Debug/${TYPE,,}/BlinkyApp.hex
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Release/${TYPE,,}/BlinkyApp.hex
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Debug/${TYPE,,}/BlinkyApp_upgrade.hex
      - boot/cypress/BlinkyApp/out/PSOC_062_${PSOC^^}/Release/${TYPE,,}/BlinkyApp_upgrade.hex
  script:
    - '[ ! -z $REPO ] && git pull $REPO $BRANCH || echo "Using current branch"'
    - git submodule deinit --all -f
    - git submodule update --init --recursive
    - cd boot/cypress
    - echo make app APP_NAME=BlinkyApp BUILDCFG=Debug PLATFORM=PSOC_062_${PSOC^^} IMG_TYPE=${TYPE^^} HEADER_OFFSET=${OFFSET} ERASED_VALUE=${ERASED,,}
    - make app APP_NAME=BlinkyApp BUILDCFG=Debug PLATFORM=PSOC_062_${PSOC^^} IMG_TYPE=${TYPE^^} HEADER_OFFSET=${OFFSET} ERASED_VALUE=${ERASED,,}
    - make app APP_NAME=BlinkyApp BUILDCFG=Release PLATFORM=PSOC_062_${PSOC^^} IMG_TYPE=${TYPE^^} HEADER_OFFSET=${OFFSET} ERASED_VALUE=${ERASED,,}

.build_mcuboot:
  tags:
    - FWS_LIN_BUILD
  needs: []
  except:
    - tags
  artifacts:
    expire_in: 4 weeks
    paths:
      - boot/cypress/MCUBootApp/out/PSOC_062_${PSOC^^}/Debug/MCUBootApp.hex
      - boot/cypress/MCUBootApp/out/PSOC_062_${PSOC^^}/Release/MCUBootApp.hex
  script:
    - '[ ! -z $REPO ] && git pull $REPO $BRANCH || echo "Using current branch"'
    - git submodule deinit --all -f
    - git submodule update --init --recursive
    - cd boot/cypress
    - echo make app APP_NAME=MCUBootApp PLATFORM=PSOC_062_${PSOC^^} BUILDCFG=Debug MCUBOOT_IMAGE_NUMBER=${IMAGES} USE_EXTERNAL_FLASH=${SMIF} USE_OVERWRITE=${OVERWRITE}
    - make app APP_NAME=MCUBootApp PLATFORM=PSOC_062_${PSOC^^} BUILDCFG=Debug MCUBOOT_IMAGE_NUMBER=${IMAGES} USE_EXTERNAL_FLASH=${SMIF} USE_OVERWRITE=${OVERWRITE}
    - make app APP_NAME=MCUBootApp PLATFORM=PSOC_062_${PSOC^^} BUILDCFG=Release MCUBOOT_IMAGE_NUMBER=${IMAGES} USE_EXTERNAL_FLASH=${SMIF} USE_OVERWRITE=${OVERWRITE}

.tests_common:
  retry:
    max: 1
  except:
    - tags
  artifacts:
    when: always
    expire_in: 12 weeks
    paths:
      - cy_boot_test_suite/test_tools/authomated_run/*.txt
  script:
    - git clone http://git-ore.aus.cypress.com/YNCI/cy_boot_test_suite.git -b $TEST_BRANCH
    - cd cy_boot_test_suite/test_tools
    - C:/Windows/System32/cmd.exe /c create_binaries.bat
    - C:/Windows/System32/cmd.exe /c ci\mcuboot\program.bat
    - C:/Windows/System32/cmd.exe /c ci\multi_062\program.bat
    - C:/Windows/System32/cmd.exe /c execute_tests.bat

.512k_swap:
  stage: 512k_swap_tests
  tags:
    - MCUBOOT_TEST_512K_SWAP
  variables:
    CI_SERIAL_PORT: COM51
    TARGET_ID: 1D1E1523012A8400
  extends: .tests_common

.1m_swap:
  stage: 1m_swap_tests
  tags:
    - MCUBOOT_TEST_1M_SWAP
  variables:
    CI_SERIAL_PORT: COM41
    TARGET_ID: 0C25186C03227400
  extends: .tests_common

.2m_swap:
  stage: 2m_swap_tests
  tags:
    - MCUBOOT_TEST_2M_SWAP
  variables:
    CI_SERIAL_PORT: COM61
    TARGET_ID: 1D18021003077400
  extends: .tests_common

.512k_overwrite:
  stage: 512k_overwrite_tests
  tags:
    - MCUBOOT_TEST_512K_OVERWRITE
  variables:
    CI_SERIAL_PORT: COM54
    TARGET_ID: 0E12080002069400
  extends: .tests_common

.1m_overwrite:
  stage: 1m_overwrite_tests
  tags:
    - MCUBOOT_TEST_1M_OVERWRITE
  variables:
    CI_SERIAL_PORT: COM44
    TARGET_ID: 031802F301237400
  extends: .tests_common

.2m_overwrite:
  stage: 2m_overwrite_tests
  tags:
    - MCUBOOT_TEST_2M_OVERWRITE
  variables:
    CI_SERIAL_PORT: COM64
    TARGET_ID: 170C0C1C02179400
  extends: .tests_common

#######################################################################################################################################
########################################################  B L I N K Y  A P P S ########################################################
#######################################################################################################################################

#################################################### 5 1 2 K  B L I N K Y  A P P S ####################################################

512k_blinky_boot:
  stage: build_blinky
  variables:
    PSOC: 512K
    TYPE: BOOT
    OFFSET: 0x00
    ERASED: 0x00
  extends: .build_blinky

512k_blinky_upgrade:
  stage: build_blinky
  variables:
    PSOC: 512K
    TYPE: UPGRADE
    OFFSET: 0x10000
    ERASED: 0x00
  extends: .build_blinky

512k_blinky_upgrade_smif:
  stage: build_blinky
  variables:
    PSOC: 512K
    TYPE: UPGRADE
    OFFSET: 0x7FE8000
    ERASED: "0xFF"
  extends: .build_blinky

###################################################### 1 M  B L I N K Y  A P P S ######################################################

1m_blinky_boot:
  stage: build_blinky
  variables:
    PSOC: 1M
    TYPE: BOOT
    OFFSET: 0x00
    ERASED: 0x00
  extends: .build_blinky

1m_blinky_upgrade:
  stage: build_blinky
  variables:
    PSOC: 1M
    TYPE: UPGRADE
    OFFSET: 0x10000
    ERASED: 0x00
  extends: .build_blinky

1m_blinky_upgrade_smif:
  stage: build_blinky
  variables:
    PSOC: 1M
    TYPE: UPGRADE
    OFFSET: 0x7FE8000
    ERASED: "0xFF"
  extends: .build_blinky

###################################################### 2 M  B L I N K Y  A P P S ######################################################

2m_blinky_boot:
  stage: build_blinky
  variables:
    PSOC: 2M
    TYPE: BOOT
    OFFSET: 0x00
    ERASED: 0x00
  extends: .build_blinky

2m_blinky_upgrade:
  stage: build_blinky
  variables:
    PSOC: 2M
    TYPE: UPGRADE
    OFFSET: 0x10000
    ERASED: 0x00
  extends: .build_blinky

2m_blinky_upgrade_smif:
  stage: build_blinky
  variables:
    PSOC: 2M
    TYPE: UPGRADE
    OFFSET: 0x7FE8000
    ERASED: "0xFF"
  extends: .build_blinky

#######################################################################################################################################
################################################### M C U B O O T   S W A P   M O D E #################################################
#######################################################################################################################################

############################################## M C U B O O T   5 1 2 K   S W A P   M O D E ############################################

512k_mcuboot_single_swap:
  stage: build_mcuboot
  variables:
    PSOC: 512K
    SMIF: 0
    IMAGES: 1
    OVERWRITE: 0
  extends: .build_mcuboot

512k_mcuboot_single_smif_swap:
  stage: build_mcuboot_smif
  variables:
    PSOC: 512K
    SMIF: 1
    IMAGES: 1
    OVERWRITE: 0
  extends: .build_mcuboot

512k_mcuboot_multi_swap:
  stage: build_mcuboot
  variables:
    PSOC: 512K
    SMIF: 0
    IMAGES: 2
    OVERWRITE: 0
  extends: .build_mcuboot

.512k_mcuboot_multi_smif_swap:
  when: manual
  stage: build_mcuboot_smif
  variables:
    PSOC: 512K
    SMIF: 1
    IMAGES: 2
    OVERWRITE: 0
  extends: .build_mcuboot

################################################ M C U B O O T   1 M   S W A P   M O D E ##############################################

1m_mcuboot_single_swap:
  stage: build_mcuboot
  variables:
    PSOC: 1M
    SMIF: 0
    IMAGES: 1
    OVERWRITE: 0
  extends: .build_mcuboot

1m_mcuboot_single_smif_swap:
  stage: build_mcuboot_smif
  variables:
    PSOC: 1M
    SMIF: 1
    IMAGES: 1
    OVERWRITE: 0
  extends: .build_mcuboot

1m_mcuboot_multi_swap:
  stage: build_mcuboot
  variables:
    PSOC: 1M
    SMIF: 0
    IMAGES: 2
    OVERWRITE: 0
  extends: .build_mcuboot

1m_mcuboot_multi_smif_swap:
  stage: build_mcuboot_smif
  variables:
    PSOC: 1M
    SMIF: 1
    IMAGES: 2
    OVERWRITE: 0
  extends: .build_mcuboot

################################################ M C U B O O T   2 M   S W A P   M O D E ##############################################

2m_mcuboot_single_swap:
  stage: build_mcuboot
  variables:
    PSOC: 2M
    SMIF: 0
    IMAGES: 1
    OVERWRITE: 0
  extends: .build_mcuboot

2m_mcuboot_single_smif_swap:
  stage: build_mcuboot_smif
  variables:
    PSOC: 2M
    SMIF: 1
    IMAGES: 1
    OVERWRITE: 0
  extends: .build_mcuboot

2m_mcuboot_multi_swap:
  stage: build_mcuboot
  variables:
    PSOC: 2M
    SMIF: 0
    IMAGES: 2
    OVERWRITE: 0
  extends: .build_mcuboot

2m_mcuboot_multi_smif_swap:
  stage: build_mcuboot_smif
  variables:
    PSOC: 2M
    SMIF: 1
    IMAGES: 2
    OVERWRITE: 0
  extends: .build_mcuboot

#######################################################################################################################################
######################################### M C U B O O T   5 1 2 K   O V E R W R I T E   M O D E #######################################
#######################################################################################################################################

######################################### M C U B O O T   5 1 2 K   O V E R W R I T E   M O D E #######################################

512k_mcuboot_single_overwrite:
  stage: build_mcuboot
  variables:
    PSOC: 512K
    SMIF: 0
    IMAGES: 1
    OVERWRITE: 1
  extends: .build_mcuboot

512k_mcuboot_single_smif_overwrite:
  stage: build_mcuboot_smif
  variables:
    PSOC: 512K
    SMIF: 1
    IMAGES: 1
    OVERWRITE: 1
  extends: .build_mcuboot

512k_mcuboot_multi_overwrite:
  stage: build_mcuboot
  variables:
    PSOC: 512K
    SMIF: 0
    IMAGES: 2
    OVERWRITE: 1
  extends: .build_mcuboot

.512k_mcuboot_multi_smif_overwrite:
  when: manual
  stage: build_mcuboot_smif
  variables:
    PSOC: 512K
    SMIF: 1
    IMAGES: 2
    OVERWRITE: 1
  extends: .build_mcuboot

########################################### M C U B O O T   1 M   O V E R W R I T E   M O D E #########################################

1m_mcuboot_single_overwrite:
  stage: build_mcuboot
  variables:
    PSOC: 1M
    SMIF: 0
    IMAGES: 1
    OVERWRITE: 1
  extends: .build_mcuboot

1m_mcuboot_single_smif_overwrite:
  stage: build_mcuboot_smif
  variables:
    PSOC: 1M
    SMIF: 1
    IMAGES: 1
    OVERWRITE: 1
  extends: .build_mcuboot

1m_mcuboot_multi_overwrite:
  stage: build_mcuboot
  variables:
    PSOC: 1M
    SMIF: 0
    IMAGES: 2
    OVERWRITE: 1
  extends: .build_mcuboot

1m_mcuboot_multi_smif_overwrite:
  stage: build_mcuboot_smif
  variables:
    PSOC: 1M
    SMIF: 1
    IMAGES: 2
    OVERWRITE: 1
  extends: .build_mcuboot

########################################### M C U B O O T   2 M   O V E R W R I T E   M O D E #########################################

2m_mcuboot_single_overwrite:
  stage: build_mcuboot
  variables:
    PSOC: 2M
    SMIF: 0
    IMAGES: 1
    OVERWRITE: 1
  extends: .build_mcuboot

2m_mcuboot_single_smif_overwrite:
  stage: build_mcuboot_smif
  variables:
    PSOC: 2M
    SMIF: 1
    IMAGES: 1
    OVERWRITE: 1
  extends: .build_mcuboot

2m_mcuboot_multi_overwrite:
  stage: build_mcuboot
  variables:
    PSOC: 2M
    SMIF: 0
    IMAGES: 2
    OVERWRITE: 1
  extends: .build_mcuboot

2m_mcuboot_multi_smif_overwrite:
  stage: build_mcuboot_smif
  variables:
    PSOC: 2M
    SMIF: 1
    IMAGES: 2
    OVERWRITE: 1
  extends: .build_mcuboot

#######################################################################################################################################
################################################## S W A P  5 1 2 K  T E S T S ########################################################
#######################################################################################################################################

512k_single_swap:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_single_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_swap
    TEST_SELECT: $TEST_OVERWRITE

512k_single_smif_swap:
  extends: .512k_swap
  needs:
    - 512k_mcuboot_single_smif_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_smif_swap
    TEST_SELECT: $TEST_OVERWRITE

512k_multi_app1_swap:
  extends: .512k_swap
  needs:
    - 512k_mcuboot_multi_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi1_swap
    TEST_SELECT: $TEST_SWAP

512k_multi_app2_swap:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap

512k_single_swap_release:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_single_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

512k_single_smif_swap_release:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_single_smif_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_smif_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

512k_multi_app1_swap_release:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi1_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

512k_multi_app2_swap_release:
  extends: .512k_swap
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_swap
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap
    BUILDCFG_TEST: Release

#######################################################################################################################################
#################################################### S W A P  1 M  T E S T S ##########################################################
#######################################################################################################################################

1m_single_swap:
  extends: .1m_swap
  needs:
    - 1m_mcuboot_single_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_swap
    TEST_SELECT: $TEST_SWAP

1m_single_smif_swap:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_smif_swap
    TEST_SELECT: $TEST_OVERWRITE

1m_multi_app1_swap:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_swap
    TEST_SELECT: $TEST_OVERWRITE

1m_multi_app2_swap:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap

1m_multi_app1_smif_swap:
  extends: .1m_swap
  needs:
    - 1m_mcuboot_multi_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_smif_swap
    TEST_SELECT: $TEST_SWAP

1m_multi_app2_smif_swap:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_smif_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap

1m_single_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

1m_single_smif_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_smif_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

1m_multi_app1_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

1m_multi_app2_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap
    BUILDCFG_TEST: Release

1m_multi_app1_smif_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_smif_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

1m_multi_app2_smif_swap_release:
  extends: .1m_swap
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_swap
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_smif_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap
    BUILDCFG_TEST: Release

#######################################################################################################################################
#################################################### S W A P  2 M  T E S T S ##########################################################
#######################################################################################################################################

2m_single_swap:
  extends: .2m_swap
  needs:
    - 2m_mcuboot_single_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_swap
    TEST_SELECT: $TEST_OVERWRITE

2m_single_smif_swap:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_smif_swap
    TEST_SELECT: $TEST_SWAP

2m_multi_app1_swap:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_swap
    TEST_SELECT: $TEST_SWAP

2m_multi_app2_swap:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap

2m_multi_app1_smif_swap:
  extends: .2m_swap
  needs:
    - 2m_mcuboot_multi_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_smif_swap
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app2_smif_swap:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_smif_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap

2m_single_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

2m_single_smif_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_smif_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app1_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app2_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap
    BUILDCFG_TEST: Release

2m_multi_app1_smif_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_smif_swap
    TEST_SELECT: $TEST_SWAP_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app2_smif_swap_release:
  extends: .2m_swap
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_swap
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_smif_swap
    TEST_SELECT: THREE_TESTS #SMOKE+ tests not applicable for second application with swap
    BUILDCFG_TEST: Release

#######################################################################################################################################
############################################## O V E R W R I T E  512 K  T E S T S ####################################################
#######################################################################################################################################

512k_single_overwrite:
  extends: .512k_overwrite
  needs:
    - 512k_mcuboot_single_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single
    TEST_SELECT: $TEST_OVERWRITE

512k_single_smif_overwrite:
  extends: .512k_overwrite
  needs:
    - 512k_mcuboot_single_smif_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_smif
    TEST_SELECT: $TEST_OVERWRITE

512k_multi1_overwrite:
  extends: .512k_overwrite
  needs:
    - 512k_mcuboot_multi_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE

512k_multi2_overwrite:
  extends: .512k_overwrite
  needs:
    - 512k_mcuboot_multi_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi2_overwrite
    TEST_SELECT: $TEST_SWAP

512k_single_overwrite_release:
  extends: .512k_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_single_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

512k_single_smif_overwrite_release:
  extends: .512k_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_single_smif_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_single_smif
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

512k_multi1_overwrite_release:
  extends: .512k_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

512k_multi2_overwrite_release:
  extends: .512k_overwrite
  only:
    - schedules
  needs:
    - 512k_mcuboot_multi_overwrite
    - 512k_blinky_boot
    - 512k_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_512K_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

#######################################################################################################################################
############################################### O V E R W R I T E  1 M  T E S T S #####################################################
#######################################################################################################################################

1m_single_overwrite:
  extends: .1m_overwrite
  needs:
    - 1m_mcuboot_single_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single
    TEST_SELECT: $TEST_OVERWRITE

1m_single_smif_overwrite:
  extends: .1m_overwrite
  needs:
    - 1m_mcuboot_single_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_smif
    TEST_SELECT: $TEST_OVERWRITE

1m_multi1_overwrite:
  extends: .1m_overwrite
  needs:
    - 1m_mcuboot_multi_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_multi2_overwrite:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_multi1_smif_overwrite:
  extends: .1m_overwrite
  needs:
    - 1m_mcuboot_multi_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_multi2_smif_overwrite:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

1m_single_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_single_smif_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_single_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_single_smif
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi1_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi2_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi1_smif_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

1m_multi2_smif_overwrite_release:
  extends: .1m_overwrite
  only:
    - schedules
  needs:
    - 1m_mcuboot_multi_smif_overwrite
    - 1m_blinky_boot
    - 1m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_1M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

#######################################################################################################################################
############################################### O V E R W R I T E  2 M  T E S T S #####################################################
#######################################################################################################################################

2m_single_overwrite:
  extends: .2m_overwrite
  needs:
    - 2m_mcuboot_single_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single
    TEST_SELECT: $TEST_OVERWRITE

2m_single_smif_overwrite:
  extends: .2m_overwrite
  needs:
    - 2m_mcuboot_single_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_smif
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app1_overwrite:
  extends: .2m_overwrite
  needs:
    - 2m_mcuboot_multi_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app2_overwrite:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app1_smif_overwrite:
  extends: .2m_overwrite
  needs:
    - 2m_mcuboot_multi_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_multi_app2_smif_overwrite:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE

2m_single_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_single_smif_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_single_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_single_smif
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app1_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app2_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app1_smif_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi1_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

2m_multi_app2_smif_overwrite_release:
  extends: .2m_overwrite
  only:
    - schedules
  needs:
    - 2m_mcuboot_multi_smif_overwrite
    - 2m_blinky_boot
    - 2m_blinky_upgrade_smif
  variables:
    TEST_CONFIG: CI_MCUBoot_2M_multi2_smif_overwrite
    TEST_SELECT: $TEST_OVERWRITE_RELEASE
    BUILDCFG_TEST: Release

#######################################################################################################################################
########################################################### C P P C H E C K ###########################################################
#######################################################################################################################################

cppcheck_mcuboot:
  stage: checks
  tags:
    - MBED_TEST
  needs: []
  except:
    - tags
  artifacts:
    when: always
    expire_in: 4 weeks
    paths:
      - boot/cypress/cppcheck/MCUBootApp/results
  allow_failure: true
  script:
    - if ($env:REPO) {git pull $REPO $BRANCH} else {echo "Using current branch"}
    - git submodule deinit --all -f
    - git submodule update --init --recursive
    - cd boot/cypress
    - git clone http://git-ore.aus.cypress.com/repo/cy_mcuboot_project/cy_mcuboot/ -b $env:CPPCHECK_BRANCH cppcheck
    - time make run_cppcheck PLATFORM=PSOC_062_2M APP_NAME=MCUBootApp CPP_CHECK_SCOPE=all BUILDCFG=Debug
    - time make run_cppcheck PLATFORM=PSOC_062_2M APP_NAME=MCUBootApp CPP_CHECK_SCOPE=all BUILDCFG=Release
